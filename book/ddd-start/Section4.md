# Chapter4 리포지터리와 모델 구현 
## 4.1 JPA를 이용한 리포지터리 구현
- 애그리거트를 어떤 저장소에 저장하느냐에 따라 구현방법이 다르다.
- 도메인 모델과 리포지터리를 구현할 때 선호하는 기술을 뽑자면 JPA다.
- 데이터 보관소로 RDBMS를 사용할 때, 객체 기반의 도메인 모델과 관계형 데이터 모델 간 매핑을 처리하는 기술로 ORM만한것이 없다.

### 4.1.1 모듈 위치
리포지터리 인터페이스는 애그리거트와 같은 도메인 영역에 속하고, 리포지터리를 구현한 클래스는 인프라스트럭처 영역에 속한다.

<img width="500" alt="스크린샷 2024-05-12 오후 5 08 08" src="https://github.com/hoa0217/study-repo/assets/48192141/07845bc4-41c3-44ec-a217-b8c23d7c3323">

팀 표준에 따라 구현 클래스를 `domain.impl`과 같은 패키지에 위치시킬 수 도 있지만, 이건은 인터페이스와 구현체를 분리하기 위한 타협안 같은 것이지 좋은 설계 원칙을 따르는 것은 아니다.
- 가능하면 리포지터리 구현 클래스를 인프라스트럭처 영억에 위치 시켜 인프라스트럭처에 대한 의존을 낮춰야한다.

### 4.1.2 리포지터리 기본 기능 구현

- ID로 애그리거트 조회하기
- 애그리거트 저장하기

기본 기능을 제공하기 위해 리포지터리는 아래와 같은 형식을 갖는다.

<img width="500" alt="스크린샷 2024-05-12 오후 5 12 18" src="https://github.com/hoa0217/study-repo/assets/48192141/566d9992-20dc-4fe1-b011-f19a0944793c">

- 주문 애그리거트는 다양한 객체를 포함하지만, 루트 엔티티은 Order를 기준으로 인터페이스를 작성한다.

#### ID로 애그리거트 조회하기
- 조회 기능 이름에 특별한 규칙은 없지만 널리 사용되는 규칙은 `findBy프로퍼티이름` 형식을 사용한다. ex) `findById()`
- 해당 ID에 애그리거트가 존재하면 객체를 리턴하고 아니면 null을 리턴한다.
- null을 사용하고 싶지 않으면 Optional을 사용한다.

<img width="500" alt="스크린샷 2024-05-12 오후 5 16 53" src="https://github.com/hoa0217/study-repo/assets/48192141/6d897f16-c695-4ea1-acef-ad69b2e981ed">

#### 애그리거트 저장하기
- save는 전달받은 애그리거트를 저장한다.

#### JPA EntityManager로 기능을 구현하면?
<img width="500" alt="스크린샷 2024-05-12 오후 5 17 59" src="https://github.com/hoa0217/study-repo/assets/48192141/30b0ff62-9cbf-41ae-9e90-a45b50be9340">

> 실제로 스프링 데이터 JPA가 알아서 만들어주므로 구현할 필요는 없다.

#### 애그리거트 수정하기
- 애그리거트를 수정하는 메서드는 추가할 필요가 없다.
- JPA를 사용하면 트랜잭션 범위에서 변경한 데이터를 자동으로 DB에 반영하기 때문이다.
- 즉, 트랜잭션을 커밋하기 직전 트랜잭션 범위에서 변경된 객체의 데이터를 반영하기 위해 UPDATE 쿼리를 자동으로 실행한다.

#### ID가 아닌 다른조건으로 애그리거트 조회하기
- findBy뒤에 조건 대상이 되는 프로퍼티 이름을 붙인다.
- 예를 들어 특정 ID가 주문한 Order목록을 구하는 메서드는 아래와 같이 정의할 수 있다.

<img width="500" alt="스크린샷 2024-05-12 오후 5 31 47" src="https://github.com/hoa0217/study-repo/assets/48192141/a33f5f1e-1646-421e-bf71-b58b23fbebf4">

<img width="500" alt="스크린샷 2024-05-12 오후 5 33 18" src="https://github.com/hoa0217/study-repo/assets/48192141/c8aa4bca-072d-4ce2-a194-249df9156af4">

> Criteria나 JPQL을 사용할 수 있으며 위에 예제는 JPQL을 사용하였다.

#### 애그리거트 삭제하기

<img width="500" alt="스크린샷 2024-05-12 오후 5 34 05" src="https://github.com/hoa0217/study-repo/assets/48192141/42ed4221-2ae7-4dec-b963-d0e34f96756f">

<img width="500" alt="스크린샷 2024-05-12 오후 5 34 27" src="https://github.com/hoa0217/study-repo/assets/48192141/b4443b54-0a8f-4f9c-b46b-a5c26b16bd87">

> 삭제 요구사항이 있더라도, 데이터를 실제 삭제하는 경우는 많지 않다. 관리자 기능에서 삭제한 데이터까지 조회해야하는 경우도 있고 데이터 원복을 위해 일정 기간 동안 보관해야할 때도 있기 때문이다.   
> 이런 이유로 삭제 기능실행 시 데이터를 바로 삭제하기 보다 삭제 플래그를 사용해서 데이터 화면에 보여줄 지 여부를 결정하는 방식으로 구현한다.



